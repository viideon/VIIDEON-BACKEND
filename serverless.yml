service: viideon-backend
frameworkVersion: '3'

custom:
  campaignTemplateTableName: '${self:service}-${sls:stage}-campaign-template'
  choicesTableName: '${self:service}-${sls:stage}-choices'
  contactTableName: '${self:service}-${sls:stage}-contact'
  emailConfigTableName: '${self:service}-${sls:stage}-email-config'
  industriesTableName: '${self:service}-${sls:stage}-industries'
  interactiveTableName: '${self:service}-${sls:stage}-interactive'
  metricsTableName: '${self:service}-${sls:stage}-metrics'
  peopleTableName: '${self:service}-${sls:stage}-people'
  publicMusicAssetsTableName: '${self:service}-${sls:stage}-public-music-assets'
  replyTableName: '${self:service}-${sls:stage}-reply'
  settingTableName: '${self:service}-${sls:stage}-setting'
  stepTableName: '${self:service}-${sls:stage}-step'
  tokenTableName: '${self:service}-${sls:stage}-token'
  userTableName: '${self:service}-${sls:stage}-user'
  userAssetsTableName: '${self:service}-${sls:stage}-user-assets'
  videosTableName: '${self:service}-${sls:stage}-videos'
  recovery:
    prod: True
    dev: False
  additionalStacks:
    tables:
      Outputs:
        CampaignTemplateStreamArn:
          Value:
            Fn::GetAtt:
              - CampaignTemplateTable
              - StreamArn
          Export:
            Name: ${self:custom.campaignTemplateTableName}-streamarn
        ChoicesStreamArn:
          Value:
            Fn::GetAtt:
              - ChoicesTable
              - StreamArn
          Export:
            Name: ${self:custom.choicesTableName}-streamarn
        ContactStreamArn:
          Value:
            Fn::GetAtt:
              - ContactTable
              - StreamArn
          Export:
            Name: ${self:custom.contactTableName}-streamarn
        EmailConfigStreamArn:
          Value:
            Fn::GetAtt:
              - EmailConfigTable
              - StreamArn
          Export:
            Name: ${self:custom.emailConfigTableName}-streamarn
        IndustriesStreamArn:
          Value:
            Fn::GetAtt:
              - IndustriesTable
              - StreamArn
          Export:
            Name: ${self:custom.industriesTableName}-streamarn
        InteractiveStreamArn:
          Value:
            Fn::GetAtt:
              - InteractiveTable
              - StreamArn
          Export:
            Name: ${self:custom.interactiveTableName}-streamarn
        MetricsStreamArn:
          Value:
            Fn::GetAtt:
              - MetricsTable
              - StreamArn
          Export:
            Name: ${self:custom.metricsTableName}-streamarn
        PeopleStreamArn:
          Value:
            Fn::GetAtt:
              - PeopleTable
              - StreamArn
          Export:
            Name: ${self:custom.peopleTableName}-streamarn
        PublicMusicAssetsStreamArn:
          Value:
            Fn::GetAtt:
              - PublicMusicAssetsTable
              - StreamArn
          Export:
            Name: ${self:custom.publicMusicAssetsTableName}-streamarn
        ReplyStreamArn:
          Value:
            Fn::GetAtt:
              - ReplyTable
              - StreamArn
          Export:
            Name: ${self:custom.replyTableName}-streamarn
        SettingStreamArn:
          Value:
            Fn::GetAtt:
              - SettingTable
              - StreamArn
          Export:
            Name: ${self:custom.settingTableName}-streamarn
        StepStreamArn:
          Value:
            Fn::GetAtt:
              - StepTable
              - StreamArn
          Export:
            Name: ${self:custom.stepTableName}-streamarn
        TokenStreamArn:
          Value:
            Fn::GetAtt:
              - TokenTable
              - StreamArn
          Export:
            Name: ${self:custom.tokenTableName}-streamarn
        UserStreamArn:
          Value:
            Fn::GetAtt:
              - UserTable
              - StreamArn
          Export:
            Name: ${self:custom.userTableName}-streamarn
        UserAssetsStreamArn:
          Value:
            Fn::GetAtt:
              - UserAssetsTable
              - StreamArn
          Export:
            Name: ${self:custom.userAssetsTableName}-streamarn
        VideosStreamArn:
          Value:
            Fn::GetAtt:
              - VideosTable
              - StreamArn
          Export:
            Name: ${self:custom.videosTableName}-streamarn
      Resources:
        CampaignTemplateTable:
          Type: AWS::DynamoDB::Table
          DeletionPolicy: Retain
          Properties:
            PointInTimeRecoverySpecification:
              PointInTimeRecoveryEnabled: ${self:custom.recovery.${sls:stage, 'dev'}}
            AttributeDefinitions:
              - AttributeName: _id
                AttributeType: S
            KeySchema:
              - AttributeName: _id
                KeyType: HASH
            BillingMode: PAY_PER_REQUEST
            TableName: ${self:custom.campaignTemplateTableName}
            StreamSpecification:
              StreamViewType: NEW_AND_OLD_IMAGES
        ChoicesTable:
          Type: AWS::DynamoDB::Table
          DeletionPolicy: Retain
          Properties:
            PointInTimeRecoverySpecification:
              PointInTimeRecoveryEnabled: ${self:custom.recovery.${sls:stage, 'dev'}}
            AttributeDefinitions:
              - AttributeName: _id
                AttributeType: S
            KeySchema:
              - AttributeName: _id
                KeyType: HASH
            BillingMode: PAY_PER_REQUEST
            TableName: ${self:custom.choicesTableName}
            StreamSpecification:
              StreamViewType: NEW_AND_OLD_IMAGES
        ContactTable:
          Type: AWS::DynamoDB::Table
          DeletionPolicy: Retain
          Properties:
            PointInTimeRecoverySpecification:
              PointInTimeRecoveryEnabled: ${self:custom.recovery.${sls:stage, 'dev'}}
            AttributeDefinitions:
              - AttributeName: _id
                AttributeType: S
            KeySchema:
              - AttributeName: _id
                KeyType: HASH
            BillingMode: PAY_PER_REQUEST
            TableName: ${self:custom.contactTableName}
            StreamSpecification:
              StreamViewType: NEW_AND_OLD_IMAGES
        EmailConfigTable:
          Type: AWS::DynamoDB::Table
          DeletionPolicy: Retain
          Properties:
            PointInTimeRecoverySpecification:
              PointInTimeRecoveryEnabled: ${self:custom.recovery.${sls:stage, 'dev'}}
            AttributeDefinitions:
              - AttributeName: _id
                AttributeType: S
            KeySchema:
              - AttributeName: _id
                KeyType: HASH
            BillingMode: PAY_PER_REQUEST
            TableName: ${self:custom.emailConfigTableName}
            StreamSpecification:
              StreamViewType: NEW_AND_OLD_IMAGES
        IndustriesTable:
          Type: AWS::DynamoDB::Table
          DeletionPolicy: Retain
          Properties:
            PointInTimeRecoverySpecification:
              PointInTimeRecoveryEnabled: ${self:custom.recovery.${sls:stage, 'dev'}}
            AttributeDefinitions:
              - AttributeName: _id
                AttributeType: S
            KeySchema:
              - AttributeName: _id
                KeyType: HASH
            BillingMode: PAY_PER_REQUEST
            TableName: ${self:custom.industriesTableName}
            StreamSpecification:
              StreamViewType: NEW_AND_OLD_IMAGES
        InteractiveTable:
          Type: AWS::DynamoDB::Table
          DeletionPolicy: Retain
          Properties:
            PointInTimeRecoverySpecification:
              PointInTimeRecoveryEnabled: ${self:custom.recovery.${sls:stage, 'dev'}}
            AttributeDefinitions:
              - AttributeName: _id
                AttributeType: S
            KeySchema:
              - AttributeName: _id
                KeyType: HASH
            BillingMode: PAY_PER_REQUEST
            TableName: ${self:custom.interactiveTableName}
            StreamSpecification:
              StreamViewType: NEW_AND_OLD_IMAGES
        MetricsTable:
          Type: AWS::DynamoDB::Table
          DeletionPolicy: Retain
          Properties:
            PointInTimeRecoverySpecification:
              PointInTimeRecoveryEnabled: ${self:custom.recovery.${sls:stage, 'dev'}}
            AttributeDefinitions:
              - AttributeName: _id
                AttributeType: S
            KeySchema:
              - AttributeName: _id
                KeyType: HASH
            BillingMode: PAY_PER_REQUEST
            TableName: ${self:custom.metricsTableName}
            StreamSpecification:
              StreamViewType: NEW_AND_OLD_IMAGES
        PeopleTable:
          Type: AWS::DynamoDB::Table
          DeletionPolicy: Retain
          Properties:
            PointInTimeRecoverySpecification:
              PointInTimeRecoveryEnabled: ${self:custom.recovery.${sls:stage, 'dev'}}
            AttributeDefinitions:
              - AttributeName: _id
                AttributeType: S
            KeySchema:
              - AttributeName: _id
                KeyType: HASH
            BillingMode: PAY_PER_REQUEST
            TableName: ${self:custom.peopleTableName}
            StreamSpecification:
              StreamViewType: NEW_AND_OLD_IMAGES
        PublicMusicAssetsTable:
          Type: AWS::DynamoDB::Table
          DeletionPolicy: Retain
          Properties:
            PointInTimeRecoverySpecification:
              PointInTimeRecoveryEnabled: ${self:custom.recovery.${sls:stage, 'dev'}}
            AttributeDefinitions:
              - AttributeName: _id
                AttributeType: S
            KeySchema:
              - AttributeName: _id
                KeyType: HASH
            BillingMode: PAY_PER_REQUEST
            TableName: ${self:custom.publicMusicAssetsTableName}
            StreamSpecification:
              StreamViewType: NEW_AND_OLD_IMAGES
        ReplyTable:
          Type: AWS::DynamoDB::Table
          DeletionPolicy: Retain
          Properties:
            PointInTimeRecoverySpecification:
              PointInTimeRecoveryEnabled: ${self:custom.recovery.${sls:stage, 'dev'}}
            AttributeDefinitions:
              - AttributeName: _id
                AttributeType: S
            KeySchema:
              - AttributeName: _id
                KeyType: HASH
            BillingMode: PAY_PER_REQUEST
            TableName: ${self:custom.replyTableName}
            StreamSpecification:
              StreamViewType: NEW_AND_OLD_IMAGES
        SettingTable:
          Type: AWS::DynamoDB::Table
          DeletionPolicy: Retain
          Properties:
            PointInTimeRecoverySpecification:
              PointInTimeRecoveryEnabled: ${self:custom.recovery.${sls:stage, 'dev'}}
            AttributeDefinitions:
              - AttributeName: _id
                AttributeType: S
              - AttributeName: userId
                AttributeType: S
              - AttributeName: name
                AttributeType: S
            KeySchema:
              - AttributeName: _id
                KeyType: HASH
              - AttributeName: userId
                KeyType: RANGE
            GlobalSecondaryIndexes:
              - IndexName: gidx-userIdName
                KeySchema:
                  - AttributeName: userId
                    KeyType: HASH
                  - AttributeName: name
                    KeyType: RANGE
                Projection:
                  ProjectionType: ALL
            BillingMode: PAY_PER_REQUEST
            TableName: ${self:custom.settingTableName}
            StreamSpecification:
              StreamViewType: NEW_AND_OLD_IMAGES
        StepTable:
          Type: AWS::DynamoDB::Table
          DeletionPolicy: Retain
          Properties:
            PointInTimeRecoverySpecification:
              PointInTimeRecoveryEnabled: ${self:custom.recovery.${sls:stage, 'dev'}}
            AttributeDefinitions:
              - AttributeName: _id
                AttributeType: S
            KeySchema:
              - AttributeName: _id
                KeyType: HASH
            BillingMode: PAY_PER_REQUEST
            TableName: ${self:custom.stepTableName}
            StreamSpecification:
              StreamViewType: NEW_AND_OLD_IMAGES
        TokenTable:
          Type: AWS::DynamoDB::Table
          DeletionPolicy: Retain
          Properties:
            PointInTimeRecoverySpecification:
              PointInTimeRecoveryEnabled: ${self:custom.recovery.${sls:stage, 'dev'}}
            AttributeDefinitions:
              - AttributeName: _id
                AttributeType: S
              - AttributeName: token
                AttributeType: S
            KeySchema:
              - AttributeName: _id
                KeyType: HASH
            BillingMode: PAY_PER_REQUEST
            TableName: ${self:custom.tokenTableName}
            GlobalSecondaryIndexes:
              - IndexName: gidx-token
                KeySchema:
                  - AttributeName: token
                    KeyType: HASH
                Projection:
                  ProjectionType: ALL
            StreamSpecification:
              StreamViewType: NEW_AND_OLD_IMAGES
        UserTable:
          Type: AWS::DynamoDB::Table
          DeletionPolicy: Retain
          Properties:
            PointInTimeRecoverySpecification:
              PointInTimeRecoveryEnabled: ${self:custom.recovery.${sls:stage, 'dev'}}
            AttributeDefinitions:
              - AttributeName: _id
                AttributeType: S
              - AttributeName: email
                AttributeType: S
            KeySchema:
              - AttributeName: _id
                KeyType: HASH
            BillingMode: PAY_PER_REQUEST
            TableName: ${self:custom.userTableName}
            GlobalSecondaryIndexes:
              - IndexName: gidx-email
                KeySchema:
                  - AttributeName: email
                    KeyType: HASH
                Projection:
                  ProjectionType: ALL
            StreamSpecification:
              StreamViewType: NEW_AND_OLD_IMAGES
        UserAssetsTable:
          Type: AWS::DynamoDB::Table
          DeletionPolicy: Retain
          Properties:
            PointInTimeRecoverySpecification:
              PointInTimeRecoveryEnabled: ${self:custom.recovery.${sls:stage, 'dev'}}
            AttributeDefinitions:
              - AttributeName: _id
                AttributeType: S
            KeySchema:
              - AttributeName: _id
                KeyType: HASH
            BillingMode: PAY_PER_REQUEST
            TableName: ${self:custom.userAssetsTableName}
            StreamSpecification:
              StreamViewType: NEW_AND_OLD_IMAGES
        VideosTable:
          Type: AWS::DynamoDB::Table
          DeletionPolicy: Retain
          Properties:
            PointInTimeRecoverySpecification:
              PointInTimeRecoveryEnabled: ${self:custom.recovery.${sls:stage, 'dev'}}
            AttributeDefinitions:
              - AttributeName: _id
                AttributeType: S
            KeySchema:
              - AttributeName: _id
                KeyType: HASH
            BillingMode: PAY_PER_REQUEST
            TableName: ${self:custom.videosTableName}
            StreamSpecification:
              StreamViewType: NEW_AND_OLD_IMAGES

provider:
  name: aws
  runtime: nodejs16.x
  architecture: arm64
  iam:
    role:
      statements:
        - Effect: Allow
          Action:
            - ssm:GetParameters
          Resource:
            - arn:aws:ssm:${aws:region}:${aws:accountId}:parameter/viideon
            - arn:aws:ssm:${aws:region}:${aws:accountId}:parameter/viideon/*
        - Effect: Allow
          Action:
            - dynamodb:Query
            - dynamodb:Scan
            - dynamodb:GetItem
            - dynamodb:PutItem
            - dynamodb:UpdateItem
            - dynamodb:DescribeTable
            - dynamodb:DeleteItem
          Resource:
            - arn:aws:dynamodb:${aws:region}:${aws:accountId}:table/${self:custom.campaignTemplateTableName}
            - arn:aws:dynamodb:${aws:region}:${aws:accountId}:table/${self:custom.choicesTableName}
            - arn:aws:dynamodb:${aws:region}:${aws:accountId}:table/${self:custom.contactTableName}
            - arn:aws:dynamodb:${aws:region}:${aws:accountId}:table/${self:custom.emailConfigTableName}
            - arn:aws:dynamodb:${aws:region}:${aws:accountId}:table/${self:custom.industriesTableName}
            - arn:aws:dynamodb:${aws:region}:${aws:accountId}:table/${self:custom.interactiveTableName}
            - arn:aws:dynamodb:${aws:region}:${aws:accountId}:table/${self:custom.metricsTableName}
            - arn:aws:dynamodb:${aws:region}:${aws:accountId}:table/${self:custom.peopleTableName}
            - arn:aws:dynamodb:${aws:region}:${aws:accountId}:table/${self:custom.publicMusicAssetsTableName}
            - arn:aws:dynamodb:${aws:region}:${aws:accountId}:table/${self:custom.replyTableName}
            - arn:aws:dynamodb:${aws:region}:${aws:accountId}:table/${self:custom.settingTableName}
            - arn:aws:dynamodb:${aws:region}:${aws:accountId}:table/${self:custom.settingTableName}/index/gidx-userIdName
            - arn:aws:dynamodb:${aws:region}:${aws:accountId}:table/${self:custom.stepTableName}
            - arn:aws:dynamodb:${aws:region}:${aws:accountId}:table/${self:custom.tokenTableName}
            - arn:aws:dynamodb:${aws:region}:${aws:accountId}:table/${self:custom.tokenTableName}/index/gidx-token
            - arn:aws:dynamodb:${aws:region}:${aws:accountId}:table/${self:custom.userTableName}
            - arn:aws:dynamodb:${aws:region}:${aws:accountId}:table/${self:custom.userTableName}/index/gidx-email
            - arn:aws:dynamodb:${aws:region}:${aws:accountId}:table/${self:custom.userAssetsTableName}
            - arn:aws:dynamodb:${aws:region}:${aws:accountId}:table/${self:custom.videosTableName}
  environment:
    CAMPAIGN_TEMPLATE_TABLE_NAME: ${self:custom.campaignTemplateTableName}
    CHOICES_TABLE_NAME: ${self:custom.choicesTableName}
    CONTACT_TABLE_NAME: ${self:custom.contactTableName}
    EMAIL_CONFIG_TABLE_NAME: ${self:custom.emailConfigTableName}
    INDUSTRIES_TABLE_NAME: ${self:custom.industriesTableName}
    INTERACTIVE_TABLE_NAME: ${self:custom.interactiveTableName}
    METRICS_TABLE_NAME: ${self:custom.metricsTableName}
    PEOPLE_TABLE_NAME: ${self:custom.peopleTableName}
    PUBLIC_MUSIC_ASSETS_TABLE_NAME: ${self:custom.publicMusicAssetsTableName}
    REPLY_TABLE_NAME: ${self:custom.replyTableName}
    SETTING_TABLE_NAME: ${self:custom.settingTableName}
    STEP_TABLE_NAME: ${self:custom.stepTableName}
    TOKEN_TABLE_NAME: ${self:custom.tokenTableName}
    USER_TABLE_NAME: ${self:custom.userTableName}
    USER_ASSETS_TABLE_NAME: ${self:custom.userAssetsTableName}
    VIDEOS_TABLE_NAME: ${self:custom.videosTableName}

plugins:
  - serverless-plugin-additional-stacks

functions:
  api:
    handler: server.handler
    timeout: 30
    events:
      - httpApi:
          path: /
          method: get
      - httpApi:
          path: /user
          method: get
      - httpApi:
          path: /user/register
          method: post
      - httpApi:
          path: /user/login
          method: post
      - httpApi:
          path: /user/update/{id}
          method: patch
      - httpApi:
          path: /user/{id}
          method: get
      - httpApi:
          path: /user/verify
          method: post
      - httpApi:
          path: /user/resendVerify
          method: post
      - httpApi:
          path: /user/forgotPassword
          method: post
      - httpApi:
          path: /user/resetPassword
          method: post
      - httpApi:
          path: /user/template
          method: post
      - httpApi:
          path: /user/template/{userId}
          method: get
      - httpApi:
          path: /user/template/{id}/{userId}
          method: patch
      - httpApi:
          path: /user/preview
          method: post
      - httpApi:
          path: /user/emailvideo
          method: post
      - httpApi:
          path: /video
          method: post
      - httpApi:
          path: /video
          method: get
      - httpApi:
          path: /video
          method: patch
      - httpApi:
          path: /video
          method: delete
      - httpApi:
          path: /video/getTemplate
          method: post
      - httpApi:
          path: /video/email
          method: post
      - httpApi:
          path: /video/updateViews
          method: post
      - httpApi:
          path: /video/updateWatch
          method: post
      - httpApi:
          path: /video/updateEmailShare
          method: post
      - httpApi:
          path: /video/update/cta
          method: post
      - httpApi:
          path: /video/user
          method: get
      - httpApi:
          path: /video/single
          method: get
      - httpApi:
          path: /video/campaignVideos
          method: get
      - httpApi:
          path: /video/multiple/email
          method: post
      - httpApi:
          path: /video/count
          method: get
      - httpApi:
          path: /video/campaign/count
          method: get
      - httpApi:
          path: /video/email/track
          method: get
      - httpApi:
          path: /contact/create
          method: post
      - httpApi:
          path: /email/config
          method: post
      - httpApi:
          path: /email/config
          method: get
      - httpApi:
          path: /email/config
          method: delete
      - httpApi:
          path: /email/send
          method: post
      - httpApi:
          path: /email/send/{id}
          method: post
      - httpApi:
          path: /asset/add
          method: post
      - httpApi:
          path: /asset/addpublicmusic
          method: post
      - httpApi:
          path: /asset/getpublicmusic
          method: get
      - httpApi:
          path: /asset/delpublicmusic/{id}
          method: delete
      - httpApi:
          path: /asset/add/music
          method: post
      - httpApi:
          path: /asset/get
          method: get
      - httpApi:
          path: /asset/getAllAssets
          method: get
      - httpApi:
          path: /asset/get/music
          method: get
      - httpApi:
          path: /asset/remove
          method: delete
      - httpApi:
          path: /asset/remove/music
          method: delete
      - httpApi:
          path: /campaign/templates
          method: get
      - httpApi:
          path: /campaign/templates
          method: post
      - httpApi:
          path: /campaign/templates
          method: patch
      - httpApi:
          path: /campaign/templates/{id}
          method: delete
      - httpApi:
          path: /industry
          method: get
      - httpApi:
          path: /industry
          method: post
      - httpApi:
          path: /industry
          method: patch
      - httpApi:
          path: /industry/{id}
          method: delete
      - httpApi:
          path: /chatvid
          method: post
      - httpApi:
          path: /chatvid
          method: get
      - httpApi:
          path: /chatvid
          method: patch
      - httpApi:
          path: /chatvid
          method: delete
      - httpApi:
          path: /chatvid/reply
          method: post
      - httpApi:
          path: /chatvid/step
          method: patch
      - httpApi:
          path: /chatvid/metrics
          method: post
      - httpApi:
          path: /chatvid/metrics/{id}
          method: post
      - httpApi:
          path: /chatvid/delete/{id}
          method: delete
